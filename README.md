# Example morph deployment to aarch64-linux host

Example of how to use [morph](https://github.com/DBCDK/morph) to deploy
[github-runner](https://github.com/actions/runner#readme) to Raspberry Pi 4. The morph command can be
run from host with any architecture, not just `aarch64-linux`.

The README will be referring to two machines:

* **deployer**: the machine you'll be running morph on. Assumed to be `x86_64-linux`.
* **target**: the machine that we're trying to run github-runner on. Assumed to be `aarch64-linux` SBC.

## Setup

1. Install NixOS using SD card image to _target_ host as described in the
   [NixOS wiki](https://nixos.wiki/wiki/NixOS_on_ARM#Installation). Default config generated by
   `nixos-generate-config` is sufficient, just make sure morph on _deployer_ can log into the
   machine using SSH. Update `hardware/pi-01.nix` with any special configuration found in its
   `/etc/nixos/hardware-configuration.nix`.

2. Configure the _deployer_ machine to be able to build `aarch64-linux` packages. You need to do
   **at least one** of the following:

   * Enable QEMU userspace emulation. It's slow but still usable if you are not rebuilding things
     from source (e.g. custom patched github-runner). Add following to _deployer_ `configuration.nix`:
     ```nix
     boot.binfmt.emulatedSystems = [ "aarch64-linux" ];
     ```

   * Configure the _target_ machine as a remote builder for the _deployer_ machine. This is faster
     than the first method but may be problematic if the _target_ machine becomes unreachable for
     some reason. Distributed builds are documented in
     [Nix manual](https://nixos.org/manual/nix/stable/advanced-topics/distributed-builds.html), and
     there are 2 steps to take here:

     * Configure SSH so that **root** on _deployer_ can log in as **any user**
       (that can start nix builds) on target machine, without password.

     * Add the remote builder to the _deployer_'s configuration.nix:
       ```nix
       nix = {
         distributedBuilds = true;
         buildMachines = [
           {
             hostName = "your-target-host.localdomain";
             system = "aarch64-linux";
             maxJobs = 4;
           }
         ];
       };
       ```

3. Update the configuration in the .nix files in this repo. At least
   [`services.github-runner.url`](https://search.nixos.org/options?channel=23.05&show=services.github-runner.url)
   needs to be changed and the
   [token file](https://search.nixos.org/options?channel=23.05&show=services.github-runner.tokenFile)
   updated accordingly.

4. Run `morph deploy --upload-secrets network.nix switch`.
